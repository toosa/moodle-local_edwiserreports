{"version":3,"sources":["block_activeusers.js"],"names":["define","$","Chart","Notification","cfg","V","common","activeUsersData","activeUsersGraph","panel","getPanel","panelBody","panelFooter","dropdownMenu","dropdownItem","dropdownToggle","flatpickrCalender","chart","loader","dropdownButton","refreshBtn","exportUrlLink","filter","dropdownInput","init","invalidUser","getActiveUsersBlockData","hide","show","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","JSON","stringify","precalculated","indexOf","done","response","error","exception","errorcode","graph","labels","fail","always","destroy","defaults","global","defaultFontFamily","fontFamily","defaultFontStyle","fontStyle","ctx","getGraphData","options","find","val","html","setInterval","inceamentUpdateTime","removeClass","fadeIn","parseInt","text","datasets","label","labelName","activeUsers","backgroundColor","borderColor","pointBorderColor","pointBackgroundColor","pointStyle","enrolments","completionRate","getActiveUsersBlock","on","addClass","ready","placeholder","attr","document","click","e","target","hasClass","parents","length","this","flatpickr","mode","altInput","altFormat","dateFormat","maxDate","appendTo","getElementById","onOpen","onClose","date","includes","changeExportUrl","filterReplaceFlag","selectedCustomDate"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @package     local_edwiserreports\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine([\n    'jquery',\n    'core/chartjs',\n    'core/notification',\n    './defaultconfig',\n    './variables',\n    './common',\n    './flatpickr'\n], function($, Chart, Notification, cfg, V, common) {\n    /* Varible for active users block */\n    var activeUsersData = null;\n    var activeUsersGraph = null;\n    var panel = cfg.getPanel(\"#activeusersblock\");\n    var panelBody = cfg.getPanel(\"#activeusersblock\", \"body\");\n    var panelTitle = cfg.getPanel(\"#activeusersblock\", \"title\");\n    var panelFooter = cfg.getPanel(\"#activeusersblock\", \"footer\");\n    var dropdownMenu = panel + \" .dropdown-menu[aria-labelledby='filter-dropdown']:not('custom')\";\n    var dropdownItem = dropdownMenu + \" .dropdown-item\";\n    var dropdownToggle = panel + \" #filter-dropdown.dropdown-toggle\";\n    var flatpickrCalender = panel + \" #flatpickrCalender\";\n    var chart = panelBody + \" .ct-chart\";\n    var loader = panelBody + \" .loader\";\n    var dropdownButton = panel + \" button#filter-dropdown\";\n    var refreshBtn = panelBody + \" .refresh\";\n    var exportUrlLink = panel + V.exportUrlLink;\n    var filter = null;\n    var dropdownInput = panelBody + \" input.form-control.input\";\n\n    /**\n     * Initialize\n     * @param {function} invalidUser Callback function\n     */\n    function init(invalidUser) {\n\n        /* Custom Dropdown hide and show */\n        activeUsersData = cfg.getActiveUsersBlock();\n\n        // If course progress block is there\n        if (activeUsersData) {\n            /* Show custom dropdown */\n            $(dropdownToggle).on(\"click\", function() {\n                $(dropdownMenu).addClass(\"show\");\n            });\n\n            /* Added Custom Value in Dropdown */\n            $(dropdownInput).ready(function() {\n                var placeholder = $(dropdownInput).attr(\"placeholder\");\n                $(dropdownInput).val(placeholder);\n            });\n\n            /* Hide dropdown when click anywhere in the screen */\n            $(document).click(function(e) {\n                if (!($(e.target).hasClass(\"dropdown-menu\") ||\n                    $(e.target).parents(\".dropdown-menu\").length)) {\n                    $(dropdownMenu).removeClass('show');\n                }\n            });\n\n            /* Select filter for active users block */\n            $(dropdownItem + \":not(.custom)\").on('click', function() {\n                filter = $(this).attr('value');\n                $(dropdownMenu).removeClass('show');\n                $(dropdownButton).html($(this).text());\n                getActiveUsersBlockData(filter);\n                $(flatpickrCalender).val(\"Custom\");\n                $(dropdownInput).val(\"Custom\");\n            });\n\n            /* Refresh when click on the refresh button */\n            $(refreshBtn).on('click', function() {\n                $(this).addClass(\"refresh-spin\");\n                getActiveUsersBlockData(filter);\n            });\n\n            createDropdownCalendar();\n            /* Call function to initialize the active users block graph */\n            getActiveUsersBlockData()\n        }\n\n        /**\n         * Create Calender in dropdown tp select range.\n         */\n        function createDropdownCalendar() {\n\n            $(flatpickrCalender).flatpickr({\n                mode: 'range',\n                altInput: true,\n                altFormat: \"d/m/Y\",\n                dateFormat: \"Y-m-d\",\n                maxDate: \"today\",\n                appendTo: document.getElementById(\"activeUser-calendar\"),\n                onOpen: function() {\n                    $(dropdownMenu).addClass('withcalendar');\n                },\n                onClose: function() {\n                    $(dropdownMenu).removeClass('withcalendar');\n                    $(dropdownMenu).removeClass('show');\n                    selectedCustomDate();\n                }\n            });\n        }\n\n        /**\n         * After Select Custom date get active users details.\n         */\n        function selectedCustomDate() {\n            filter = $(flatpickrCalender).val();\n            var date = $(dropdownInput).val();\n\n            /* If correct date is not selected then return false */\n            if (!filter.includes(\"to\")) {\n                return;\n            }\n\n            cfg.changeExportUrl(filter, exportUrlLink, V.filterReplaceFlag);\n            $(dropdownButton).html(date);\n            $(flatpickrCalender).val(\"\");\n            getActiveUsersBlockData(filter);\n        }\n\n        /**\n         * Get data for active users block.\n         * @param {String} filter Filter string\n         */\n        function getActiveUsersBlockData(filter) {\n            $(chart).hide();\n            $(loader).show();\n\n            /* If filter is not set then select all */\n            if (!filter) {\n                filter = \"weekly\";\n            }\n            // Show loader.\n            common.loader.show('#activeusersblock');\n            $.ajax({\n                url: cfg.requestUrl,\n                type: cfg.requestType,\n                dataType: cfg.requestDataType,\n                data: {\n                    action: 'get_activeusers_graph_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    data: JSON.stringify({\n                        precalculated: ['weekly', 'monthly', 'yearly'].indexOf(filter) !== -1,\n                        filter: filter\n                    })\n                },\n            }).done(function(response) {\n                if (response.error === true && response.exception.errorcode === 'invalidsecretkey') {\n                    invalidUser('activeusersblock', response);\n                    return;\n                }\n                activeUsersData.graph.data = response.data;\n                activeUsersData.graph.labels = response.labels;\n            }).fail(function(error) {\n                Notification.exception(error);\n            }).always(function() {\n                activeUsersGraph = generateActiveUsersGraph();\n                // V.changeExportUrl(filter, exportUrlLink, V.filterReplaceFlag);\n                $(panelFooter).find('.download-links input[name=\"filter\"]').val(filter);\n\n                // Change graph variables\n                resetUpdateTime();\n                setInterval(inceamentUpdateTime, 1000 * 60);\n                $(refreshBtn).removeClass('refresh-spin');\n                $(loader).hide();\n                $(chart).fadeIn(\"slow\");\n\n                // Hide loader.\n                common.loader.hide('#activeusersblock');\n            });\n        }\n\n        /**\n         * Reset Update time in panel header.\n         */\n        function resetUpdateTime() {\n            $(panelBody + \" #updated-time > span.minute\").html(0);\n        }\n\n        /**\n         * Increament update time in panel header.\n         */\n        function inceamentUpdateTime() {\n            $(panelBody + \" #updated-time > span.minute\")\n            .html(parseInt($(panelBody + \" #updated-time > span.minute\").text()) + 1);\n        }\n\n        /**\n         * Generate Active Users graph.\n         * @returns {Object} Active users graph\n         */\n        function generateActiveUsersGraph() {\n            if (activeUsersGraph) {\n                activeUsersGraph.destroy();\n            }\n\n            Chart.defaults.global.defaultFontFamily = activeUsersData.graph.fontFamily;\n            Chart.defaults.global.defaultFontStyle = activeUsersData.graph.fontStyle;\n            activeUsersGraph = new Chart(activeUsersData.ctx, {\n                type: activeUsersData.graph.type,\n                data: getGraphData(),\n                options: activeUsersData.graph.options\n            });\n            return activeUsersGraph;\n        }\n\n        /**\n         * Get graph data.\n         * @return {Object}\n         */\n        function getGraphData() {\n            try {\n                return {\n                    labels: activeUsersData.graph.labels,\n                    datasets: [{\n                        label: activeUsersData.graph.labelName.activeUsers,\n                        data: activeUsersData.graph.data.activeUsers,\n                        backgroundColor: activeUsersData.graph.backgroundColor.activeUsers,\n                        borderColor: activeUsersData.graph.borderColor.activeUsers,\n                        pointBorderColor: activeUsersData.graph.borderColor.activeUsers,\n                        pointBackgroundColor: activeUsersData.graph.borderColor.activeUsers,\n                        pointStyle: activeUsersData.graph.pointStyle\n                    },\n                    {\n                        label: activeUsersData.graph.labelName.enrolments,\n                        data: activeUsersData.graph.data.enrolments,\n                        backgroundColor: activeUsersData.graph.backgroundColor.enrolments,\n                        borderColor: activeUsersData.graph.borderColor.enrolments,\n                        pointBorderColor: activeUsersData.graph.borderColor.enrolments,\n                        pointBackgroundColor: activeUsersData.graph.borderColor.enrolments,\n                        pointStyle: activeUsersData.graph.pointStyle\n                    },\n                    {\n                        label: activeUsersData.graph.labelName.completionRate,\n                        data: activeUsersData.graph.data.completionRate,\n                        backgroundColor: activeUsersData.graph.backgroundColor.completionRate,\n                        borderColor: activeUsersData.graph.borderColor.completionRate,\n                        pointBorderColor: activeUsersData.graph.borderColor.completionRate,\n                        pointBackgroundColor: activeUsersData.graph.borderColor.completionRate,\n                        pointStyle: activeUsersData.graph.pointStyle\n                    }]\n                };\n            } catch (error) {\n                return {};\n            }\n        }\n    }\n\n    // Must return the init function\n    return {\n        init: init\n    };\n});\n"],"file":"block_activeusers.min.js"}